<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ë„ì±…ë°© - ì§€ì  ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--grape-900:#1a0a2e;--grape-800:#2d1b4e;--grape-700:#4a2c7a;--grape-500:#7c4dff;--grape-300:#b794f4;--grape-100:#e9d8fd;--grape-50:#f5f0ff;--warning:#f59e0b;--success:#10b981;--text-light:#666}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Pretendard',sans-serif;background:#f5f7fa;display:flex;min-height:100vh}
        .sidebar{width:260px;background:linear-gradient(180deg,var(--grape-900),var(--grape-800));padding:1.5rem;position:fixed;top:0;left:0;bottom:0}
        .sidebar-logo{display:flex;align-items:center;gap:0.6rem;padding-bottom:1.25rem;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:1.25rem}
        .sidebar-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .sidebar-logo-text{color:white;font-family:'Noto Serif KR',serif;font-weight:700;font-size:1.1rem}
        .sidebar-user{padding:0.85rem;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:1.25rem}
        .sidebar-user-name{color:white;font-weight:600}
        .sidebar-user-role{color:var(--grape-300);font-size:0.8rem}
        .sidebar-nav{display:flex;flex-direction:column;gap:0.3rem}
        .sidebar-item{display:flex;align-items:center;gap:0.6rem;padding:0.75rem 0.85rem;color:rgba(255,255,255,0.7);border-radius:8px;cursor:pointer;font-size:0.9rem}
        .sidebar-item:hover{background:rgba(255,255,255,0.1);color:white}
        .sidebar-item.active{background:linear-gradient(135deg,#f59e0b,#d97706);color:white}
        .main{flex:1;margin-left:260px;padding:1.5rem 2rem}
        .main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .main-title{font-family:'Noto Serif KR',serif;font-size:1.5rem;font-weight:700;color:var(--grape-900)}
        .quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
        .quick-card{background:white;border-radius:14px;padding:1.25rem;text-align:center;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
        .quick-card:hover{border-color:#f59e0b;transform:translateY(-2px)}
        .quick-icon{width:45px;height:45px;margin:0 auto 0.75rem;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
        .quick-title{font-weight:600;color:var(--grape-900);font-size:0.9rem}
        .quick-desc{font-size:0.75rem;color:var(--text-light)}
        .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:white;border-radius:14px;padding:1.25rem}
        .stat-card-header{display:flex;justify-content:space-between;margin-bottom:0.75rem}
        .stat-card-title{font-size:0.8rem;color:var(--text-light)}
        .stat-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
        .stat-card-value{font-size:1.75rem;font-weight:700;color:var(--grape-900)}
        .stat-card-change{font-size:0.8rem;color:var(--success)}
        .card{background:white;border-radius:14px;overflow:hidden;margin-bottom:1.5rem}
        .card-header{padding:1.25rem;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
        .card-title{font-weight:700;color:var(--grape-900)}
        .scanner{background:#1a1a2e;border-radius:16px;padding:2rem;text-align:center;color:white}
        .scanner-view{width:100%;height:180px;background:#16213e;border-radius:12px;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
        .scanner-line{position:absolute;width:80%;height:2px;background:var(--success);box-shadow:0 0 10px var(--success);animation:scan 2s infinite}
        @keyframes scan{0%,100%{top:15%}50%{top:85%}}
        .scanner-input{width:100%;padding:1rem;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:10px;color:white;font-size:1.2rem;text-align:center;letter-spacing:2px}
        .scanner-input::placeholder{color:rgba(255,255,255,0.4)}
        .btn{padding:1rem 2rem;border-radius:10px;font-weight:600;cursor:pointer;border:none;width:100%;margin-top:1rem}
        .btn-warning{background:linear-gradient(135deg,#f59e0b,#d97706);color:white}
        .btn-secondary{background:white;color:var(--grape-700);border:1px solid var(--grape-300)}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th,.data-table td{padding:0.85rem 1rem;text-align:left;border-bottom:1px solid #f0f0f0;font-size:0.9rem}
        .data-table th{background:#fafafa;font-weight:600;color:var(--text-light);font-size:0.8rem}
        .data-table tbody tr:hover{background:#fffbeb}
        .badge{padding:0.25rem 0.6rem;border-radius:50px;font-size:0.75rem;font-weight:600}
        .badge-success{background:#d1fae5;color:#065f46}
        .badge-warning{background:#fef3c7;color:#92400e}
        .toast{position:fixed;top:1.5rem;right:1.5rem;padding:1rem 1.5rem;background:white;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.15);display:none;z-index:300}
        .toast.show{display:flex;align-items:center;gap:0.5rem}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid #ef4444}
        @media(max-width:1100px){.stat-grid,.quick-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:900px){.sidebar{width:70px;padding:1rem 0.5rem}.sidebar-logo-text,.sidebar-item span:last-child,.sidebar-user-name,.sidebar-user-role{display:none}.sidebar-logo,.sidebar-item{justify-content:center}.main{margin-left:70px}}
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    <aside class="sidebar">
        <div class="sidebar-logo"><div class="sidebar-logo-icon">ğŸª</div><span class="sidebar-logo-text">í¬ë„ì±…ë°©</span></div>
        <div class="sidebar-user"><div class="sidebar-user-name" id="userName">ì§€ì  ê´€ë¦¬ì</div><div class="sidebar-user-role" id="branchName">ì§€ì  ê´€ë¦¬</div></div>
        <nav class="sidebar-nav">
            <div class="sidebar-item active" data-section="overview"><span>ğŸ“Š</span><span>ëŒ€ì‹œë³´ë“œ</span></div>
            <div class="sidebar-item" data-section="pos"><span>ğŸ’³</span><span>POS / íŒë§¤</span></div>
            <div class="sidebar-item" data-section="owners"><span>ğŸ‘¥</span><span>ì ì£¼ ê´€ë¦¬</span></div>
            <div class="sidebar-item" data-section="books"><span>ğŸ“š</span><span>ë„ì„œ ê´€ë¦¬</span></div>
            <div class="sidebar-item" data-section="goods"><span>ğŸ</span><span>êµ¿ì¦ˆ ê´€ë¦¬</span></div>
            <div class="sidebar-item" data-section="sales"><span>ğŸ’°</span><span>íŒë§¤ ë‚´ì—­</span></div>
            <div class="sidebar-item" data-section="settlements"><span>ğŸ§¾</span><span>ì •ì‚° ê´€ë¦¬</span></div>
            <div class="sidebar-item" data-section="shelves"><span>ğŸ“¦</span><span>ì„œê°€ ê´€ë¦¬</span></div>
        </nav>
        <div style="margin-top:auto;padding-top:1rem"><div class="sidebar-item" onclick="doLogout()"><span>ğŸšª</span><span>ë¡œê·¸ì•„ì›ƒ</span></div></div>
    </aside>
    <main class="main" id="mainContent"></main>
    
    <!-- Add Book Modal -->
    <div class="modal-overlay" id="addBookModal">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3 class="modal-title">ğŸ“– ë„ì„œ ë“±ë¡</h3><button class="modal-close" onclick="closeModal('addBookModal')">Ã—</button></div>
            <div class="modal-body">
                <div class="scanner">
                    <div class="scanner-view"><div class="scanner-line"></div><span style="opacity:0.5">ISBN ë°”ì½”ë“œ ìŠ¤ìº”</span></div>
                    <input type="text" class="scanner-input" id="bookIsbn" placeholder="ISBN ì…ë ¥">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
                    <div class="form-group" style="margin:0"><label class="form-label">ë„ì„œëª… *</label><input type="text" class="form-input" id="bookTitle"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">ì €ì *</label><input type="text" class="form-input" id="bookAuthor"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
                    <div class="form-group" style="margin:0"><label class="form-label">ì¶œíŒì‚¬</label><input type="text" class="form-input" id="bookPublisher"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">íŒë§¤ê°€ *</label><input type="number" class="form-input" id="bookPrice"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                    <div class="form-group" style="margin:0"><label class="form-label">ìƒíƒœ (ì •ì‚°ìœ¨)</label><select class="form-select" id="bookCondition"><option value="order_new">ì£¼ë¬¸ìƒˆì±… (0:100)</option><option value="owner_new">ì ì£¼ìƒˆì±… (15:85)</option><option value="used" selected>í—Œì±… (50:50)</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">ì ì£¼/ì„œê°€ *</label><select class="form-select" id="bookOwner"></select></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('addBookModal')">ì·¨ì†Œ</button><button class="btn" style="background:#10b981;color:white" onclick="saveBook(true)">ë“±ë¡+QR</button><button class="btn btn-warning" style="color:white" onclick="saveBook(false)">ë“±ë¡</button></div>
        </div>
    </div>
    
    <script src="podo-db.js"></script>
    <script>
        let branchId = null;
        document.addEventListener('DOMContentLoaded', () => {
            const session = PodoSession.get();
            if (!session || session.type !== 'branch') { location.href = 'login-branch.html'; return; }
            branchId = session.branchId;
            const branch = (PodoDB.get('branches')||[]).find(b => b.id === branchId);
            document.getElementById('userName').textContent = session.user.name || 'ê´€ë¦¬ì';
            document.getElementById('branchName').textContent = branch?.name || 'ì§€ì ';
            renderSection('overview');
            setupNav();
        });
        function setupNav() {
            document.querySelectorAll('.sidebar-item[data-section]').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    renderSection(this.dataset.section);
                });
            });
        }
        function renderSection(section) {
            const main = document.getElementById('mainContent');
            const stats = calcStats(branchId);
            const sales = (PodoDB.get('sales')||[]).filter(s => s.branchId === branchId);
            const books = (PodoDB.get('books')||[]).filter(b => b.branchId === branchId);
            const owners = (PodoDB.get('owners')||[]).filter(o => o.branchId === branchId);
            const branch = (PodoDB.get('branches')||[]).find(b => b.id === branchId);

            if (section === 'overview') {
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">${branch?.icon||'ğŸª'} ${branch?.name||'ì§€ì '} ëŒ€ì‹œë³´ë“œ</h1></div>
                    <div class="quick-grid">
                        <div class="quick-card" onclick="renderSection('pos')"><div class="quick-icon">ğŸ’³</div><div class="quick-title">íŒë§¤ ì²˜ë¦¬</div><div class="quick-desc">ë°”ì½”ë“œ ìŠ¤ìº”</div></div>
                        <div class="quick-card" onclick="openAddBookModal()"><div class="quick-icon">ğŸ“–</div><div class="quick-title">ë„ì„œ ë“±ë¡</div><div class="quick-desc">ISBN ìŠ¤ìº”</div></div>
                        <div class="quick-card" onclick="showToast('ì˜ìˆ˜ì¦ì´ ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤','success')"><div class="quick-icon">ğŸ§¾</div><div class="quick-title">ì˜ìˆ˜ì¦ ì¶œë ¥</div><div class="quick-desc">ì¬ì¶œë ¥</div></div>
                        <div class="quick-card" onclick="renderSection('books')"><div class="quick-icon">ğŸ“‹</div><div class="quick-title">ì¬ê³  í™•ì¸</div><div class="quick-desc">ì‹¤ì‹œê°„</div></div>
                    </div>
                    <div class="stat-grid">
                        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">ì˜¤ëŠ˜ ë§¤ì¶œ</span><div class="stat-card-icon" style="background:#d1fae5;color:#065f46">ğŸ’°</div></div><div class="stat-card-value">${formatMoney(stats.todaySales)}</div><div class="stat-card-change">â†‘ ${stats.todayCount}ê±´</div></div>
                        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">í™œì„± ì„œê°€</span><div class="stat-card-icon" style="background:#dbeafe;color:#1e40af">ğŸ“¦</div></div><div class="stat-card-value">${stats.ownerCount}/${branch?.shelfCount||0}</div></div>
                        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">ë“±ë¡ ë„ì„œ</span><div class="stat-card-icon" style="background:#fef3c7;color:#92400e">ğŸ“š</div></div><div class="stat-card-value">${stats.bookCount}</div></div>
                        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">í™œì„± ì ì£¼</span><div class="stat-card-icon" style="background:#e9d8fd;color:#5b21b6">ğŸ‘¥</div></div><div class="stat-card-value">${stats.ownerCount}ëª…</div></div>
                    </div>
                    <div class="card"><div class="card-header"><span class="card-title">ì˜¤ëŠ˜ íŒë§¤ ë‚´ì—­</span><button class="btn btn-secondary" onclick="exportSales(branchId)">ğŸ“¥ ì—‘ì…€</button></div>
                        <table class="data-table"><thead><tr><th>ì‹œê°„</th><th>ë„ì„œëª…</th><th>ì ì£¼</th><th>ê²°ì œ</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody>${sales.filter(s=>s.date.startsWith(getTodayStr())).reverse().map(s => `<tr><td>${s.date.split(' ')[1]||''}</td><td>${s.bookTitle||'-'}</td><td>${s.ownerName||'-'}</td><td>${s.method==='card'?'ì¹´ë“œ':'í˜„ê¸ˆ'}</td><td>${formatMoney(s.price)}</td><td><span class="badge badge-success">ì™„ë£Œ</span></td></tr>`).join('')||'<tr><td colspan="6" style="text-align:center;color:var(--text-light)">ì˜¤ëŠ˜ íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'}</tbody>
                        </table>
                    </div>
                    <div class="card"><div class="card-header"><span class="card-title">ğŸ“ˆ ì£¼ê°„ ë§¤ì¶œ</span></div><div class="card-body"><canvas id="branchChart" height="60"></canvas></div></div>`;
                setTimeout(() => drawBranchChart(), 100);
            } else if (section === 'pos') {
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ’³ POS / íŒë§¤</h1></div>
                    <div class="scanner">
                        <div class="scanner-view">
                            <video id="posVideo" style="width:100%;height:100%;object-fit:cover;display:none"></video>
                            <div class="scanner-line"></div>
                            <span id="posPlaceholder" style="opacity:0.5">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</span>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem">
                            <button onclick="startPosScanner()" style="flex:1;padding:0.75rem;background:var(--success);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº”</button>
                            <button onclick="stopPosScanner()" style="padding:0.75rem 1rem;background:#666;color:white;border:none;border-radius:8px;cursor:pointer">ì¤‘ì§€</button>
                        </div>
                        <input type="text" class="scanner-input" id="posInput" placeholder="ISBN ë˜ëŠ” ë„ì„œID" autofocus onkeypress="if(event.key==='Enter')processPOS()">
                        <button class="btn btn-warning" onclick="processPOS()">íŒë§¤ ì²˜ë¦¬</button>
                    </div>
                    <div class="card" style="margin-top:1.5rem"><div class="card-header"><span class="card-title">ìµœê·¼ íŒë§¤</span></div>
                        <table class="data-table"><thead><tr><th>ì‹œê°„</th><th>ë„ì„œëª…</th><th>ê¸ˆì•¡</th></tr></thead>
                        <tbody>${sales.slice(-5).reverse().map(s => `<tr><td>${s.date.split(' ')[1]||''}</td><td>${s.bookTitle||'-'}</td><td>${formatMoney(s.price)}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>`;
                setTimeout(() => document.getElementById('posInput')?.focus(), 100);
            } else if (section === 'owners') {
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ‘¥ ì ì£¼ ê´€ë¦¬</h1></div>
                    <div class="card"><table class="data-table">
                        <thead><tr><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì„œê°€</th><th>ë„ì„œìˆ˜</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody>${owners.map(o => `<tr><td><strong>${o.name}</strong></td><td>${o.phone}</td><td>${o.shelves?.join(', ')||'-'}</td><td>${books.filter(b=>b.ownerId===o.id).length}ê¶Œ</td><td><span class="badge ${o.status==='active'?'badge-success':'badge-warning'}">${o.status==='active'?'í™œì„±':'íœ´ë©´'}</span></td></tr>`).join('')}</tbody>
                    </table></div>`;
            } else if (section === 'books') {
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ“š ë„ì„œ ê´€ë¦¬</h1><button class="btn btn-warning" style="color:white" onclick="openAddBookModal()">+ ë„ì„œ ë“±ë¡</button></div>
                    <div class="card"><table class="data-table">
                        <thead><tr><th>ë„ì„œëª…</th><th>ì €ì</th><th>ìƒíƒœ</th><th>ì ì£¼</th><th>ì„œê°€</th><th>ê°€ê²©</th><th>QR</th></tr></thead>
                        <tbody>${books.map(b => {
                            const owner = owners.find(o=>o.id===b.ownerId);
                            const statusName = BOOK_STATUS && BOOK_STATUS[b.status] ? BOOK_STATUS[b.status].name : b.status;
                            return `<tr><td><strong>${b.title}</strong></td><td>${b.author}</td><td><span class="badge badge-success">${statusName}</span></td><td>${owner?.ownerNumber||owner?.name||'-'}</td><td>${b.shelf||'-'}</td><td>${formatMoney(b.price)}</td><td><button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem" onclick="printQRLabel({id:'${b.id}',title:'${b.title}',ownerNumber:'${b.ownerNumber||''}',price:${b.price}})">ğŸ·ï¸</button></td></tr>`;
                        }).join('')}</tbody>
                    </table></div>`;
            } else if (section === 'goods') {
                const goods = (PodoDB.get('goods')||[]).filter(g => g.branchId === branchId);
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ êµ¿ì¦ˆ ê´€ë¦¬</h1><button class="btn btn-warning" style="color:white" onclick="openGoodsModal()">+ êµ¿ì¦ˆ ë“±ë¡</button></div>
                    <div class="stat-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1rem">
                        <div class="stat-card"><div class="stat-card-title">í¬ë„</div><div class="stat-card-value">${goods.filter(g=>g.status==='podo').length}</div></div>
                        <div class="stat-card"><div class="stat-card-title">í˜‘ë ¥</div><div class="stat-card-value">${goods.filter(g=>g.status==='collab').length}</div></div>
                        <div class="stat-card"><div class="stat-card-title">ìì‘</div><div class="stat-card-value">${goods.filter(g=>g.status==='handmade').length}</div></div>
                        <div class="stat-card"><div class="stat-card-title">ìœ„íƒ</div><div class="stat-card-value">${goods.filter(g=>g.status==='consign').length}</div></div>
                    </div>
                    <div class="card"><table class="data-table">
                        <thead><tr><th>ìƒí’ˆëª…</th><th>ìƒíƒœ</th><th>ê°€ê²©</th><th>ìˆ˜ëŸ‰</th><th>ì ì£¼</th><th>QR</th></tr></thead>
                        <tbody>${goods.map(g => {
                            const owner = owners.find(o=>o.id===g.ownerId);
                            const statusName = GOODS_STATUS && GOODS_STATUS[g.status] ? GOODS_STATUS[g.status].name : g.status;
                            return `<tr><td><strong>${g.name}</strong></td><td><span class="badge badge-success">${statusName}</span></td><td>${formatMoney(g.price)}</td><td>${g.qty}ê°œ</td><td>${g.ownerNumber||owner?.name||'í¬ë„ì±…ë°©'}</td><td><button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem" onclick="printQRLabel({id:'${g.id}',title:'${g.name}',ownerNumber:'${g.ownerNumber||''}',price:${g.price}})">ğŸ·ï¸</button></td></tr>`;
                        }).join('')}</tbody>
                    </table></div>`;
            } else if (section === 'shelves') {
                const shelves = (PodoDB.get('shelves')||[]).filter(s => s.branchId === branchId);
                const usedShelves = shelves.filter(s => s.ownerId);
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ“¦ ì„œê°€ ê´€ë¦¬</h1></div>
                    <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem">
                        <div class="stat-card"><div class="stat-card-title">ì „ì²´ ì„œê°€</div><div class="stat-card-value">${shelves.length}</div></div>
                        <div class="stat-card"><div class="stat-card-title">ì‚¬ìš©ì¤‘</div><div class="stat-card-value" style="color:var(--success)">${usedShelves.length}</div></div>
                        <div class="stat-card"><div class="stat-card-title">ê³µì‹¤</div><div class="stat-card-value" style="color:var(--warning)">${shelves.length - usedShelves.length}</div></div>
                    </div>
                    <div class="card"><table class="data-table">
                        <thead><tr><th>ì„œê°€ì½”ë“œ</th><th>íƒ€ì…</th><th>ì›”ì„ëŒ€ë£Œ</th><th>ì ì£¼</th><th>ë„ì„œìˆ˜</th><th>ìƒíƒœ</th></tr></thead>
                        <tbody>${shelves.map(s => {
                            const owner = owners.find(o => o.id === s.ownerId);
                            const shelfBooks = books.filter(b => b.shelf === s.code);
                            return `<tr><td><strong>${s.code}</strong></td><td>${s.type === 'small' ? 'ì†Œí˜•' : 'ì¤‘í˜•'}</td><td>${formatMoney(s.price)}</td><td>${owner?.name || '-'}</td><td>${shelfBooks.length}ê¶Œ</td><td><span class="badge ${s.ownerId ? 'badge-success' : 'badge-warning'}">${s.ownerId ? 'ì‚¬ìš©ì¤‘' : 'ê³µì‹¤'}</span></td></tr>`;
                        }).join('')}</tbody>
                    </table></div>`;
            } else if (section === 'sales') {
                // íŒë§¤ ë‚´ì—­
                const allSales = sales.slice().reverse();
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ’° íŒë§¤ ë‚´ì—­</h1><button class="btn btn-secondary" onclick="exportSales(branchId)">ğŸ“¥ ì—‘ì…€</button></div>
                    <div class="card" style="padding:1rem;margin-bottom:1rem">
                        <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
                            <div><label style="font-size:0.85rem;color:var(--text-light)">ì‹œì‘ì¼</label><input type="date" id="salesStartDate" class="form-input" style="width:auto;padding:0.5rem" onchange="filterSales()"></div>
                            <div><label style="font-size:0.85rem;color:var(--text-light)">ì¢…ë£Œì¼</label><input type="date" id="salesEndDate" class="form-input" style="width:auto;padding:0.5rem" onchange="filterSales()"></div>
                            <button class="btn btn-secondary" style="padding:0.5rem 1rem" onclick="resetSalesFilter()">ì´ˆê¸°í™”</button>
                            <div style="margin-left:auto;font-weight:600" id="salesSummary">ì´ ${allSales.length}ê±´ / ${formatMoney(allSales.reduce((s,x)=>s+x.price,0))}</div>
                        </div>
                    </div>
                    <div class="card"><table class="data-table" id="salesTable">
                        <thead><tr><th>ì¼ì‹œ</th><th>ìƒí’ˆëª…</th><th>ìƒíƒœ</th><th>ì ì£¼</th><th>ê²°ì œ</th><th>íŒë§¤ê°€</th><th>ì±…ë°©</th><th>ì ì£¼ëª«</th><th>ì²˜ë¦¬</th></tr></thead>
                        <tbody>${allSales.map(s => `<tr data-date="${(s.createdAt||s.date||'').split(' ')[0]}"><td style="font-size:0.8rem">${s.createdAt||s.date||''}</td><td>${s.itemTitle||s.bookTitle||'-'}</td><td style="font-size:0.75rem">${s.status||'-'}</td><td>${s.ownerNumber||s.ownerName||'-'}</td><td>${s.method==='card'?'ì¹´ë“œ':s.method==='cash'?'í˜„ê¸ˆ':'ê³„ì¢Œ'}</td><td>${formatMoney(s.price)}</td><td style="color:var(--text-light)">${formatMoney(s.shopAmount||0)}</td><td style="color:#10b981">${formatMoney(s.ownerAmount||s.price)}</td><td>${s.saleStatus!=='refunded'?`<button class="btn btn-secondary" style="padding:0.2rem 0.5rem;font-size:0.7rem" onclick="refundSale('${s.id}')">ë°˜í’ˆ</button>`:'<span style="color:#ef4444">ë°˜í’ˆë¨</span>'}</td></tr>`).join('')||'<tr><td colspan="9" style="text-align:center">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'}</tbody>
                    </table></div>`;
            } else if (section === 'settlements') {
                // ì •ì‚° ê´€ë¦¬
                const settlements = (PodoDB.get('settlements')||[]).filter(s => owners.some(o => o.id === s.ownerId));
                main.innerHTML = `
                    <div class="main-header"><h1 class="main-title">ğŸ§¾ ì •ì‚° ê´€ë¦¬</h1></div>
                    <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem">
                        <div class="stat-card"><div class="stat-card-title">ì´ë²ˆ ë‹¬ íŒë§¤</div><div class="stat-card-value">${formatMoney(sales.filter(s=>(s.createdAt||s.date||'').startsWith(getTodayStr().slice(0,7))).reduce((a,b)=>a+b.price,0))}</div></div>
                        <div class="stat-card"><div class="stat-card-title">ì •ì‚° ëŒ€ê¸° ì ì£¼</div><div class="stat-card-value">${owners.filter(o=>o.status==='active').length}ëª…</div></div>
                        <div class="stat-card"><div class="stat-card-title">ì •ì‚° ì˜ˆì •ì¼</div><div class="stat-card-value">ë§¤ì›” 10ì¼</div></div>
                    </div>
                    <div class="card"><div class="card-header"><span class="card-title">ì ì£¼ë³„ ì •ì‚° í˜„í™© (ì´ë²ˆ ë‹¬)</span></div>
                        <table class="data-table">
                            <thead><tr><th>ì ì£¼ë²ˆí˜¸</th><th>ì´ë¦„</th><th>íŒë§¤ì•¡</th><th>ì±…ë°©ëª«</th><th>ì ì£¼ëª«</th><th>ì„ëŒ€ë£Œ</th><th>ì •ì‚°ì˜ˆì •</th></tr></thead>
                            <tbody>${owners.filter(o=>o.status==='active').map(o => {
                                const ownerSales = sales.filter(s => s.ownerId === o.id && (s.createdAt||s.date||'').startsWith(getTodayStr().slice(0,7)));
                                const totalSales = ownerSales.reduce((a,b)=>a+b.price,0);
                                const shopAmount = ownerSales.reduce((a,b)=>a+(b.shopAmount||0),0);
                                const ownerAmount = ownerSales.reduce((a,b)=>a+(b.ownerAmount||b.price),0);
                                const ownerShelves = (PodoDB.get('shelves')||[]).filter(s=>s.ownerId===o.id);
                                const rent = ownerShelves.reduce((a,b)=>a+b.price,0);
                                const finalAmount = ownerAmount - rent;
                                return `<tr><td><strong>${o.ownerNumber||'-'}</strong></td><td>${o.name}</td><td>${formatMoney(totalSales)}</td><td style="color:var(--text-light)">${formatMoney(shopAmount)}</td><td style="color:#10b981">${formatMoney(ownerAmount)}</td><td>-${formatMoney(rent)}</td><td style="font-weight:700;color:${finalAmount>=0?'var(--grape-700)':'#ef4444'}">${formatMoney(finalAmount)}</td></tr>`;
                            }).join('')||'<tr><td colspan="7" style="text-align:center">ì ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>'}</tbody>
                        </table>
                    </div>
                    <div class="card"><div class="card-header"><span class="card-title">ì •ì‚° ì´ë ¥</span></div>
                        <table class="data-table">
                            <thead><tr><th>ê¸°ê°„</th><th>ì ì£¼</th><th>íŒë§¤ì•¡</th><th>ì •ì‚°ì•¡</th><th>ìƒíƒœ</th></tr></thead>
                            <tbody>${settlements.map(s => `<tr><td>${s.period}</td><td>${s.ownerName||'-'}</td><td>${formatMoney(s.totalSales||s.sales)}</td><td style="font-weight:600">${formatMoney(s.finalAmount||s.amount)}</td><td><span class="badge ${s.status==='completed'?'badge-success':'badge-warning'}">${s.status==='completed'?'ì™„ë£Œ':'ëŒ€ê¸°'}</span></td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center">ì •ì‚° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'}</tbody>
                        </table>
                    </div>`;
            } else {
                main.innerHTML = `<div class="main-header"><h1 class="main-title">${section}</h1></div><div class="card" style="padding:2rem;text-align:center"><p>ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p></div>`;
            }
        }
        function processPOS() {
            const input = document.getElementById('posInput');
            const books = PodoDB.get('books') || [];
            const goods = PodoDB.get('goods') || [];
            const owners = PodoDB.get('owners') || [];
            
            // ì±… ë˜ëŠ” êµ¿ì¦ˆ ì°¾ê¸°
            let item = books.find(b => (b.isbn === input.value || b.id === input.value) && b.branchId === branchId && b.saleStatus === 'available');
            if (!item) {
                item = goods.find(g => g.id === input.value && g.branchId === branchId && g.saleStatus === 'available');
            }
            // êµ¬ë²„ì „ í˜¸í™˜
            if (!item) {
                item = books.find(b => (b.isbn === input.value || b.id === input.value) && b.branchId === branchId && b.status === 'available');
            }
            
            if (item) {
                // processSale í•¨ìˆ˜ ì‚¬ìš© (podo-db.js)
                if (typeof processSale === 'function') {
                    const sale = processSale(item, 'card');
                    showToast(`íŒë§¤ ì™„ë£Œ: ${item.title||item.name} (â‚©${item.price.toLocaleString()})`, 'success');
                } else {
                    // êµ¬ë²„ì „ í˜¸í™˜
                    const owner = owners.find(o => o.id === item.ownerId);
                    const sales = PodoDB.get('sales') || [];
                    const settlement = calculateSettlement ? calculateSettlement(item.price, item.type || 'book', item.status) : {shopAmount: 0, ownerAmount: item.price};
                    const newSale = {
                        id: PodoDB.generateId('SL'),
                        itemId: item.id,
                        itemType: item.type || 'book',
                        itemTitle: item.title || item.name,
                        price: item.price,
                        status: item.status,
                        shopAmount: settlement.shopAmount,
                        ownerAmount: settlement.ownerAmount,
                        ownerId: item.ownerId,
                        ownerNumber: item.ownerNumber || owner?.ownerNumber || '',
                        branchId: branchId,
                        method: 'card',
                        saleStatus: 'completed',
                        createdAt: getTodayStr() + ' ' + getTimeStr()
                    };
                    sales.push(newSale);
                    item.saleStatus = 'sold';
                    item.status = 'sold';
                    PodoDB.set('sales', sales);
                    PodoDB.set('books', books);
                    PodoDB.set('goods', goods);
                    showToast('íŒë§¤ ì™„ë£Œ: ' + (item.title||item.name) + ' (' + formatMoney(item.price) + ')', 'success');
                }
                input.value = '';
                renderSection('pos');
            } else {
                showToast('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ íŒë§¤ë¨', 'error');
            }
        }
        function doLogout() {
            PodoSession.clear();
            showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            setTimeout(() => location.href = 'index.html', 500);
        }
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = 'toast show ' + (type || 'success');
            t.innerHTML = (type === 'error' ? 'âŒ' : 'âœ“') + ' ' + msg;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function openAddBookModal() {
            const owners = (PodoDB.get('owners') || []).filter(o => o.branchId === branchId && o.status === 'active');
            document.getElementById('bookOwner').innerHTML = '<option value="">ì„ íƒ</option>' + owners.map(o => `<option value="${o.id}">${o.name} (${o.shelves?.join(',')||'-'})</option>`).join('');
            openModal('addBookModal');
        }
        
        function saveBook(printQR = false) {
            const books = PodoDB.get('books') || [];
            const owners = PodoDB.get('owners') || [];
            const ownerId = document.getElementById('bookOwner').value;
            const owner = owners.find(o => o.id === ownerId);
            
            if (!ownerId || !document.getElementById('bookTitle').value || !document.getElementById('bookPrice').value) {
                showToast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return;
            }
            
            const newBook = {
                id: PodoDB.generateId('BK'),
                type: 'book',
                isbn: document.getElementById('bookIsbn').value || '',
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                publisher: document.getElementById('bookPublisher').value,
                price: parseInt(document.getElementById('bookPrice').value),
                qty: 1,
                status: document.getElementById('bookCondition').value,
                shelf: owner?.shelves?.[0] || '',
                ownerId: ownerId,
                ownerNumber: owner?.ownerNumber || '',
                branchId: branchId,
                saleStatus: 'available',
                createdAt: getTodayStr()
            };
            books.push(newBook);
            PodoDB.set('books', books);
            closeModal('addBookModal');
            showToast('ë„ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
            if (printQR) {
                printQRLabel(newBook);
            }
            
            renderSection('books');
            ['bookIsbn','bookTitle','bookAuthor','bookPublisher','bookPrice'].forEach(id => document.getElementById(id).value = '');
        }

        // êµ¿ì¦ˆ ëª¨ë‹¬
        function openGoodsModal() {
            // ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸ë¡œ ëŒ€ì²´ (ëª¨ë‹¬ ì¶”ê°€í•˜ë ¤ë©´ HTML í•„ìš”)
            const name = prompt('êµ¿ì¦ˆ ìƒí’ˆëª…:');
            if (!name) return;
            const price = parseInt(prompt('íŒë§¤ê°€:'));
            if (!price) return;
            const statusList = {'1':'podo','2':'collab','3':'handmade','4':'consign'};
            const statusInput = prompt('ìƒíƒœ ì„ íƒ:\n1.í¬ë„(100:0)\n2.í˜‘ë ¥(30:70)\n3.ìì‘(20:80)\n4.ìœ„íƒ(20:80)') || '3';
            const status = statusList[statusInput] || 'handmade';
            
            const owners = (PodoDB.get('owners')||[]).filter(o=>o.branchId===branchId&&o.status==='active');
            let ownerId = null, ownerNumber = '';
            if (status !== 'podo' && owners.length > 0) {
                const ownerName = prompt('ì ì£¼ ì´ë¦„ (í¬ë„ì±…ë°© ìì²´ë©´ ë¹„ì›Œë‘ê¸°):');
                if (ownerName) {
                    const owner = owners.find(o => o.name.includes(ownerName));
                    if (owner) { ownerId = owner.id; ownerNumber = owner.ownerNumber; }
                }
            }
            
            const goods = PodoDB.get('goods') || [];
            const newGoods = {
                id: PodoDB.generateId('GD'),
                type: 'goods',
                name: name,
                price: price,
                qty: 1,
                status: status,
                shelf: '',
                ownerId: ownerId,
                ownerNumber: ownerNumber,
                branchId: branchId,
                saleStatus: 'available',
                createdAt: getTodayStr()
            };
            goods.push(newGoods);
            PodoDB.set('goods', goods);
            showToast('êµ¿ì¦ˆê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            renderSection('goods');
        }

        // QR ë¼ë²¨ ì¶œë ¥
        function printQRLabel(item) {
            const qrData = encodeURIComponent(JSON.stringify({ id: item.id, ownerNumber: item.ownerNumber, price: item.price }));
            const qrImageUrl = `https://chart.googleapis.com/chart?chs=100x100&cht=qr&chl=${qrData}&choe=UTF-8`;
            
            const printWindow = window.open('', '_blank', 'width=300,height=400');
            printWindow.document.write(`
                <html>
                <head><title>QR ë¼ë²¨</title>
                <style>body{margin:0;padding:10mm;font-family:sans-serif}
                .label{width:50mm;padding:3mm;border:1px solid #000;text-align:center}
                .title{font-size:11px;font-weight:bold;margin-bottom:2mm;max-height:14px;overflow:hidden}
                .owner{font-size:9px;color:#666;margin-bottom:3mm}
                .qr{width:18mm;height:18mm;margin:0 auto 2mm}
                .price{font-size:14px;font-weight:bold}</style>
                </head>
                <body>
                <div class="label">
                    <div class="title">${item.title || item.name}</div>
                    <div class="owner">${item.ownerNumber || 'í¬ë„ì±…ë°©'}</div>
                    <img src="${qrImageUrl}" class="qr">
                    <div class="price">â‚©${item.price.toLocaleString()}</div>
                </div>
                <script>window.onload=function(){window.print();}<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ì°¨íŠ¸
        function drawBranchChart() {
            const canvas = document.getElementById('branchChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const data = getSalesChartData(7, branchId);
            
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const padding = { top: 15, right: 15, bottom: 30, left: 50 };
            const chartWidth = width/2 - padding.left - padding.right;
            const chartHeight = height/2 - padding.top - padding.bottom;
            const maxAmount = Math.max(...data.map(d => d.amount), 10000);
            
            ctx.fillStyle = '#fffbeb';
            ctx.fillRect(0, 0, width/2, height/2);
            
            const barWidth = chartWidth / data.length * 0.6;
            data.forEach((d, i) => {
                const x = padding.left + (chartWidth / data.length) * i + (chartWidth / data.length * 0.2);
                const barHeight = (d.amount / maxAmount) * chartHeight;
                const y = padding.top + chartHeight - barHeight;
                
                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#666';
                ctx.font = '9px Pretendard';
                ctx.textAlign = 'center';
                ctx.fillText(d.label.split('(')[0], x + barWidth/2, height/2 - 8);
            });
        }

        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ
        async function startPosScanner() {
            const video = document.getElementById('posVideo');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.style.display = 'block';
                video.play();
                document.getElementById('posPlaceholder').style.display = 'none';
                
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'code_128', 'qr_code'] });
                    const scan = async () => {
                        if (!video.srcObject) return;
                        try {
                            const barcodes = await detector.detect(video);
                            if (barcodes.length > 0) {
                                document.getElementById('posInput').value = barcodes[0].rawValue;
                                stopPosScanner();
                                showToast('ìŠ¤ìº”: ' + barcodes[0].rawValue, 'success');
                                processPOS();
                                return;
                            }
                        } catch(e) {}
                        if (video.srcObject) requestAnimationFrame(scan);
                    };
                    scan();
                }
            } catch (err) {
                showToast('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            }
        }

        function stopPosScanner() {
            const video = document.getElementById('posVideo');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
                video.style.display = 'none';
            }
            const ph = document.getElementById('posPlaceholder');
            if (ph) ph.style.display = 'block';
        }

        // íŒë§¤ë‚´ì—­ ê¸°ê°„ í•„í„°
        function filterSales() {
            const startDate = document.getElementById('salesStartDate')?.value;
            const endDate = document.getElementById('salesEndDate')?.value;
            const rows = document.querySelectorAll('#salesTable tbody tr');
            let total = 0, count = 0;
            
            rows.forEach(row => {
                const date = row.dataset.date;
                let show = true;
                if (startDate && date < startDate) show = false;
                if (endDate && date > endDate) show = false;
                row.style.display = show ? '' : 'none';
                if (show) {
                    count++;
                    const priceCell = row.cells[5];
                    if (priceCell) {
                        const price = parseInt(priceCell.textContent.replace(/[â‚©,]/g, '')) || 0;
                        total += price;
                    }
                }
            });
            
            const summary = document.getElementById('salesSummary');
            if (summary) summary.textContent = `ì´ ${count}ê±´ / ${formatMoney(total)}`;
        }
        
        function resetSalesFilter() {
            const startEl = document.getElementById('salesStartDate');
            const endEl = document.getElementById('salesEndDate');
            if (startEl) startEl.value = '';
            if (endEl) endEl.value = '';
            filterSales();
        }

        // ë°˜í’ˆ ì²˜ë¦¬
        function refundSale(saleId) {
            if (!confirm('ì´ íŒë§¤ë¥¼ ë°˜í’ˆ ì²˜ë¦¬í• ê¹Œìš”?')) return;
            
            if (typeof processRefund === 'function') {
                const result = processRefund(saleId);
                if (result) {
                    showToast('ë°˜í’ˆ ì²˜ë¦¬ ì™„ë£Œ', 'success');
                    renderSection('sales');
                } else {
                    showToast('ë°˜í’ˆ ì²˜ë¦¬ ì‹¤íŒ¨', 'error');
                }
            } else {
                // êµ¬ë²„ì „ í˜¸í™˜
                const sales = PodoDB.get('sales') || [];
                const sale = sales.find(s => s.id === saleId);
                if (sale) {
                    sale.saleStatus = 'refunded';
                    sale.status = 'refunded';
                    PodoDB.set('sales', sales);
                    
                    // ì¬ê³  ë³µêµ¬
                    const books = PodoDB.get('books') || [];
                    const book = books.find(b => b.id === sale.bookId || b.id === sale.itemId);
                    if (book) {
                        book.status = 'available';
                        book.saleStatus = 'available';
                        PodoDB.set('books', books);
                    }
                    
                    showToast('ë°˜í’ˆ ì²˜ë¦¬ ì™„ë£Œ', 'success');
                    renderSection('sales');
                }
            }
        }
    </script>
</body>
</html>